<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Jamaica Decision 2025 — Live Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --accent:#0a58ca;
    --card:#ffffff; --card-alt:#f8fafc; --shadow:0 6px 18px rgba(17,24,39,.06);
    --jlp:#2e8b57; --pnp:#ff8c00; --jpp:#6a0dad; --uic:#008b8b; --other:#1e90ff;
    --radius:12px;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}

  /* Header */
  .header{position:sticky; top:0; z-index:60; background:#ffffff; border-bottom:1px solid var(--border)}
  .header-inner{max-width:1800px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; gap:18px; flex-wrap:wrap}
  .brand{font-weight:800; font-size:1.25rem; letter-spacing:.2px}
  .live-pill{margin-left:auto; display:flex; align-items:center; gap:8px; font-weight:700}
  .live-dot{width:10px; height:10px; border-radius:50%; background:#ef4444; animation:pulse 1.8s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
  .refresh{display:flex; align-items:center; gap:6px}
  select{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; color:#111827}

  /* Source status pills (Main vs Backup) */
  .status-group{display:flex; align-items:center; gap:12px; margin-left:8px}
  .status-pill{
    display:flex; align-items:center; gap:8px;
    background:#fff; border:1px solid var(--border); border-radius:999px;
    padding:6px 10px; font-weight:800; color:#111827;
  }
  .status-pill small{color:var(--muted); font-weight:600}
  .dot{width:10px; height:10px; border-radius:50%; animation:pulse 1.8s infinite; background:#10b981}
  .dot.ok{ background:#10b981 }     /* green */
  .dot.warn{ background:#f59e0b }   /* orange */
  .dot.bad{ background:#ef4444 }    /* red */

  /* Tabs */
  .tabs{background:#f7f8fb; border-bottom:1px solid var(--border)}
  .tabs-inner{max-width:1800px; margin:0 auto; padding:0 24px; display:flex; gap:24px}
  .tab{padding:14px 2px; cursor:pointer; border-bottom:3px solid transparent; color:#374151; font-weight:700}
  .tab.active{border-color:var(--accent); color:#0b1220}

  /* Topline */
  .topline{background:#fbfcff; border-bottom:1px solid var(--border)}
  .topline-inner{max-width:1800px; margin:0 auto; padding:12px 24px; display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .tcard{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 12px; display:flex; gap:12px; align-items:center}
  .tlogo{height:22px; width:auto}
  .tstats{font-size:.98rem; color:var(--muted)} .tstats b{color:var(--text)}
  .delta{font-weight:800; margin-left:6px} .delta.up{color:#16a34a} .delta.down{color:#ef4444}

  /* Page grid */
  .page{display:grid; grid-template-columns:1fr minmax(0,1600px) 320px 1fr; gap:16px}
  .page > .main{grid-column:2}
  .page > .rightbar{grid-column:3}
  @media (max-width:1300px){ .page{display:block} .rightbar{position:relative; width:auto; max-width:none} }

  /* Sidebar */
  .rightbar{position:sticky; top:92px; align-self:start; height:calc(100vh - 108px); overflow:auto;
    background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:12px}
  .rightbar h3{margin:2px 0 8px 0; font-size:1rem}
  .sideitem{position:relative; display:flex; justify-content:space-between; align-items:center;
    border:2px solid var(--border); border-radius:12px; padding:8px 10px; margin:8px 0; font-weight:800; cursor:pointer; background:#fff}
  .sideitem small{color:var(--muted)}
  .sideitem::before{content:""; position:absolute; inset:-2px; border-radius:14px; padding:2px; background:
    conic-gradient(from var(--angle,0deg), rgba(22,163,74,.9), rgba(245,158,11,.9), rgba(239,68,68,.9), rgba(22,163,74,.9));
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:.2; animation:spin 12s linear infinite}
  @keyframes spin{to{--angle:360deg}}
  .age-good{border-color:var(--good)} .age-warn{border-color:var(--warn)} .age-bad{border-color:var(--bad)}

  /* Sections / cards */
  .container{max-width:1600px; margin:14px auto; padding:0 24px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}

  /* Controls */
  .controls{display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
  .controls input, .controls select{border:1px solid var(--border); border-radius:10px; padding:10px 12px}
  .controls input#searchBar{width:360px; max-width:90vw}
  .controls input#cnoFilter{width:120px}

  /* Parish -> constituency blocks */
  .parish{margin:12px 0 22px}
  .parish h2{font-size:1.1rem; border-left:4px solid var(--accent); padding-left:10px; margin:0 0 12px}
  .const-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
  .const{background:#fff; border:2px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer}
  .const-head{background:linear-gradient(180deg,#f9fafb,#eef2f7); border-bottom:1px solid var(--border);
    padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  .const-name{font-weight:900; font-size:1rem; line-height:1.2; background:#fff; padding:3px 8px; border:1px solid var(--border); border-radius:8px}
  .updated{font-size:.85rem; color:var(--muted); display:flex; flex-direction:column; align-items:flex-end; text-align:right; gap:4px; white-space:nowrap}
  .pulse{display:inline-block; width:10px; height:10px; border-radius:50%; background:currentColor; animation:pulseSoft 1.8s infinite}
  @keyframes pulseSoft{0%{box-shadow:0 0 0 0 rgba(0,0,0,.2)}70%{box-shadow:0 0 0 10px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}
  .const-body{padding:12px; display:flex; flex-direction:column; gap:8px}
  .winner-badge{display:inline-flex; align-items:center; gap:6px; font-weight:800; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.08)}
  .winner-badge .check{font-weight:900}
  .boxline{font-size:.9rem; color:var(--muted); margin-top:2px}

  /* Rows (5 columns) */
  .rows{margin-top:6px; border-top:1px solid var(--border)}
  .row{
    display:grid;
    grid-template-columns:35px 1fr 40px 70px 52px; /* icon | name | party | votes | % */
    gap:12px; padding:10px 4px;
    align-items:start;
    border-bottom:1px solid var(--border);
    min-height:44px;
    background:var(--card-alt);
  }
  .row:last-child{border-bottom:none}

  /* Candidate name: allow up to 2 lines */
  .nm{
    font-weight:700;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
    line-height:1.15;
  }

  .party{ text-align:center; font-weight:800; color:#0b1220; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:.3px; }
  .votes{font-weight:800; text-align:right}
  .pct{color:var(--muted); text-align:right}
  .party-icon{height:18px; width:auto; display:block; margin-top:2px}

  /* Scoreboard + charts */
  .scoreboard{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  .pcard{border:1px solid var(--border); border-radius:10px; padding:14px; background:#fff}
  .phead{display:flex; align-items:center; justify-content:space-between}
  .pmain{font-size:1.8rem; font-weight:800}
  .bar{height:8px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:8px}
  .bar>span{display:block; height:100%}
  .charts{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(420px,1fr))}
  .chart-wrap{position:relative; height:300px}
  canvas{position:absolute; inset:0}

  .closelist{list-style:none; padding:0; margin:0; display:grid; gap:8px}
  .closelist li{display:flex; justify-content:space-between; gap:10px; border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 12px; cursor:pointer}

  /* Maps */
  .map-wrap{position:relative; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#eef2f7}
  #mapContainer{height:460px}
  #imapMap{height:60vh; min-height:380px; max-height:72vh}
  .mapControls{position:absolute; right:8px; top:8px; z-index:500}
  .btn{background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700}
  .btn:hover{filter:brightness(0.98)}
  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px}
  .legend-item{display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:999px}
  .swatch{width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.15)}
  .leaflet-tooltip{background:#111827; color:#f9fafb; border:0; border-radius:8px; padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .leaflet-container{background:#eef2f7}
  .leaflet-control-attribution{display:none}

  /* Bottom ticker */
  .ticker{position:sticky; bottom:0; z-index:65; background:#0b1220; color:#fff; border-top:1px solid #0f172a}
  .ticker-inner{max-width:1600px; margin:0 auto; padding:10px 24px; display:flex; align-items:center; gap:12px; overflow:hidden}
  .tick-title{font-weight:800; margin-right:8px}
  .marquee{white-space:nowrap; overflow:hidden; flex:1}
  .marquee span{display:inline-block; padding-left:100%; animation:scroll 180s linear infinite}
  @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  .hidden{display:none !important}

  /* tiny toast */
  .toast{position:fixed; right:12px; bottom:72px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); z-index:1000; font-weight:700}
</style>
</head>
<body>
  <div class="page">
    <!-- MAIN -->
    <div class="main">
      <!-- Header -->
      <header class="header">
        <div class="header-inner">
          <div class="brand">Jamaica Decision 2025 — Live Results</div>
          <div class="refresh">
            <span style="color:var(--muted)">Auto-refresh:</span>
            <select id="refreshSel">
              <option value="15000">15s</option>
              <option value="30000">30s</option>
              <option value="60000" selected>1m</option>
              <option value="120000">2m</option>
              <option value="300000">5m</option>
            </select>
          </div>
          <!-- Parity pills -->
          <div class="status-group" id="sourceStatus">
            <div class="status-pill" id="pillMain" title="Waiting for first check…">
              <span class="dot ok" aria-hidden="true"></span> Main <small id="mainLag">OK</small>
            </div>
            <div class="status-pill" id="pillBackup" title="Waiting for first check…">
              <span class="dot ok" aria-hidden="true"></span> Backup <small id="backupLag">OK</small>
            </div>
          </div>
          <div class="live-pill"><span class="live-dot"></span><span id="lastUpdated">Updating…</span></div>
        </div>
      </header>

      <!-- Tabs -->
      <nav class="tabs">
        <div class="tabs-inner">
          <div class="tab" data-tab="national">National</div>
          <div class="tab active" data-tab="constituencies">Constituencies</div>
          <div class="tab" data-tab="interactive">Interactive Map</div>
        </div>
      </nav>

      <!-- Topline -->
      <section class="topline">
        <div class="topline-inner" id="toplineBar"></div>
      </section>

      <!-- NATIONAL -->
      <section id="tab-national" class="hidden">
        <div class="container">
          <div class="scoreboard" id="scoreboard"></div>

          <div class="charts">
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Total Votes by Party</h2>
              <div class="chart-wrap"><canvas id="voteChart"></canvas></div>
            </div>
            <div class="card">
              <h2 style="color:var(--muted); font-size:1rem">Seats Won by Party</h2>
              <div class="chart-wrap"><canvas id="seatChart"></canvas></div>
            </div>
          </div>

          <div class="card">
            <h2>Top 10 Closest Seats</h2>
            <ul id="closestList" class="closelist"></ul>
            <p id="closestNote" style="color:var(--muted); margin-top:8px"></p>
          </div>

          <div class="card">
            <h2>Seats Won Map</h2>
            <div class="map-wrap">
              <div id="mapContainer"></div>
              <div class="mapControls"><button id="btnResetNational" class="btn">Reset view</button></div>
            </div>
            <div id="mapLegend" class="legend"></div>
          </div>
        </div>
      </section>

      <!-- CONSTITUENCIES -->
      <section id="tab-constituencies">
        <div class="container">
          <div class="card">
            <div class="controls">
              <input id="searchBar" type="text" placeholder="Search candidate or text…">
              <select id="parishFilter"><option value="">All Parishes</option></select>
              <select id="partyFilter">
                <option value="">All Parties</option>
                <option>JLP</option><option>PNP</option><option>JPP</option><option>UIC</option><option>Other</option>
              </select>
              <input id="cnoFilter" type="text" inputmode="numeric" placeholder="Const. #">
              <div class="split">
                <label for="sortField" style="color:var(--muted); font-weight:700">Sort by</label>
                <select id="sortField">
                  <option value="cno">Const #</option>
                  <option value="name">Const name</option>
                  <option value="parish">Parish</option>
                  <option value="party">Leading party</option>
                </select>
                <select id="sortDir">
                  <option value="asc">Asc</option>
                  <option value="desc">Desc</option>
                </select>
              </div>
            </div>
            <h2>Constituencies by Parish</h2>
            <div id="parishContainer"></div>
          </div>
        </div>
      </section>

      <!-- INTERACTIVE MAP -->
      <section id="tab-interactive" class="hidden">
        <div class="container">
          <div class="card">
            <h2>Interactive Map</h2>
            <div class="map-wrap">
              <div id="imapMap"></div>
              <div class="mapControls"><button id="btnResetInteractive" class="btn">Reset view</button></div>
            </div>
            <div id="imapLegend" class="legend" style="margin-top:8px"></div>
            <div id="imapDetails" class="card" style="margin-top:12px">
              <h2 style="margin-top:0">Constituency Details</h2>
              <div id="imapContent" class="small">Click a constituency to see results here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT SIDEBAR -->
    <aside class="rightbar" aria-label="Recently Updated Constituency Numbers">
      <h3>Recently Updated (#)</h3>
      <div id="sidebarList"></div>
    </aside>
  </div>

  <!-- Bottom ticker -->
  <div class="ticker">
    <div class="ticker-inner">
      <span class="tick-title">Live Updates:</span>
      <div class="marquee"><span id="tickerText">—</span></div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const AUTO_DEFAULT = 60000;
const ECJ_GEOJSON =
 'https://services6.arcgis.com/3R3y1KXaPJ9BFnsU/arcgis/rest/services/ECJWEB_MAP/FeatureServer/6/query?where=1%3D1&outFields=*&f=geojson';
const JAMAICA_BOUNDS = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
const PARTY_COLORS = { JLP:'#2e8b57', PNP:'#ff8c00', JPP:'#6a0dad', UIC:'#008b8b', Other:'#1e90ff' };
const PARTY_LOGOS = {
  JLP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JLP_logo-300x98.png",
  PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_logo-300x182.png",
  JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_logo-300x275.png",
  UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_logo-300x164.png",
  Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
};
const PARTY_SYMBOLS = {
  JLP:"https://ecj.com.jm/wp-content/uploads/2025/03/JLP_symbol.png",
  PNP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/PNP_symbol.png",
  JPP:"https://www.ecj.com.jm/wp-content/uploads/2025/03/JPP_symbol-300x261.png",
  UIC:"https://www.ecj.com.jm/wp-content/uploads/2025/03/UIC_symbol-300x106.png",
  Other:"https://static.vecteezy.com/system/resources/thumbnails/012/025/259/small_2x/jamaica-flag-with-grunge-texture-png.png"
};
const CORE_PARTIES = ["JLP","PNP","JPP","UIC"];
const TICKER_MAX_AGE = 15*60*1000;   // <= 15 min
const SIDEBAR_MAX_AGE = 25*60*1000;  // <= 25 min

/* ===== Data source URLs (proxy-aware) ===== */
const PROXY_BASE = 'https://decision2025.odaneforsythe.workers.dev/';
const DIRECT_MAIN   = 'https://jamaica-elections.com/general/2025/show/jsonapi.php';
const DIRECT_BACKUP = 'https://onedrex.net:9443/election/api/view/constituency-details/v2/carlito2025';
const PROXY_MAIN   = PROXY_BASE + '?url=' + encodeURIComponent(DIRECT_MAIN);
const PROXY_BACKUP = PROXY_BASE + '?url=' + encodeURIComponent(DIRECT_BACKUP);
const isGithubPages = /github\.io$/i.test(location.hostname);
const DATA_URL        = isGithubPages ? PROXY_MAIN   : DIRECT_MAIN;   // primary data feed
const MAIN_DATA_URL   = isGithubPages ? PROXY_MAIN   : DIRECT_MAIN;   // parity: main
const BACKUP_DATA_URL = isGithubPages ? PROXY_BACKUP : DIRECT_BACKUP; // parity: backup
const PARITY_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes

/* Optional alias (navigation resilience only) */
const ALIASES = {
  [norm('Kingston Eastern and Port Royal')]: norm('Kingston East and Port Royal')
};

/* ===== State ===== */
let voteChart=null, seatChart=null, refreshTimer=null, timerInterval=null;
let mapNational=null, mapInteractive=null, geoLayerNational=null, geoLayerInteractive=null;
let arcFeatures=[], byParish={}, constNameToNo={}, constNameToParish={};
let leaderColors = {}; let focusedKey = null; let pendingFocusName = null;
let lastSeats = JSON.parse(localStorage.getItem('lastSeats') || '{}');
let lastConstHashes = JSON.parse(localStorage.getItem('constituencyHashes')||'{}');
let lastConstUpdated = JSON.parse(localStorage.getItem('constituencyUpdated')||'{}');

/* ===== Utils ===== */
function norm(s){ return String(s||'').toLowerCase().replace(/[\s\-\u2013\u2014'’.]/g,'').replace(/&/g,'and'); }
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4000); }
function contrastText(hex){ try{ const c=hex.replace('#',''); const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16); return ((r*299+g*587+b*114)/1000>=140)?'#0b1220':'#ffffff'; }catch{ return '#0b1220'; } }
function fmtHHMMSS(ms){ const s=Math.max(0,Math.floor(ms/1000)); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
function makeHash(cands){ return cands.map(k=>`${(k.Party||'Other').toUpperCase()}|${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}|${Number(k.Votes||0)}`).join(';'); }
const partyKey = p => {
  const P = String(p||'Other').toUpperCase();
  if (P.startsWith('INDA') || P.startsWith('INDB')) return 'Other';
  return ['JLP','PNP','JPP','UIC'].includes(P) ? P : 'Other';
};
const bust = url => url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now();

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('tab-'+t.dataset.tab).classList.remove('hidden');
  if (t.dataset.tab==='national' && mapNational) setTimeout(()=>mapNational.invalidateSize(), 60);
  if (t.dataset.tab==='interactive' && mapInteractive) {
    setTimeout(()=>mapInteractive.invalidateSize(), 60);
    if (pendingFocusName){ focusConstituencyByName(pendingFocusName); pendingFocusName=null; }
    else {
      const cur = document.getElementById('imapContent')?.dataset?.currentKey;
      if (cur) focusConstituencyByName(cur, true);
    }
  }
}));

/* ===== Auto refresh ===== */
const sel = document.getElementById('refreshSel');
sel.value = localStorage.getItem('refreshIntervalMs') || String(AUTO_DEFAULT);
sel.addEventListener('change', ()=>{ localStorage.setItem('refreshIntervalMs', sel.value); setupAutoRefresh(); });

/* ===== Maps ===== */
const JAMAICA_BOUNDS_LEAF = L.latLngBounds([17.6, -78.6], [18.6, -76.0]);
function initNationalMap(){
  if (mapNational) return;
  mapNational = L.map('mapContainer',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15}).addTo(mapNational);
  mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
  mapNational.setMinZoom(mapNational.getZoom());
  document.getElementById('btnResetNational').onclick = ()=>{
    mapNational.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapNational.setMinZoom(mapNational.getZoom());
    setTimeout(()=> mapNational.invalidateSize(), 40);
  };
}
function initInteractiveMap(){
  if (mapInteractive) return;
  mapInteractive = L.map('imapMap',{zoomControl:true, attributionControl:false, maxBounds:JAMAICA_BOUNDS_LEAF, maxBoundsViscosity:1});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{minZoom:7, maxZoom:15}).addTo(mapInteractive);
  mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
  mapInteractive.setMinZoom(mapInteractive.getZoom());
  document.getElementById('btnResetInteractive').onclick = ()=>{
    mapInteractive.fitBounds(JAMAICA_BOUNDS_LEAF);
    mapInteractive.setMinZoom(mapInteractive.getZoom());
    focusedKey = null; pendingFocusName = null;
    const cont = document.getElementById('imapContent');
    cont.textContent = 'Click a constituency to see results here.';
    cont.dataset.currentKey = '';
    if (geoLayerInteractive){
      geoLayerInteractive.eachLayer(l=>{
        try{ l.closeTooltip(); }catch(_){}
        const nm = l.feature?.properties?.CONST_NAME || '';
        const key = norm(nm);
        const fill = leaderColors[key] || '#e5e7eb';
        l.setStyle({ fillColor:fill, fillOpacity:0.75, color:'#94a3b8', weight:1 });
      });
    }
    setTimeout(()=> mapInteractive.invalidateSize(), 40);
  };
  window.addEventListener('resize', ()=> setTimeout(()=> mapInteractive.invalidateSize(), 40));
}
function buildLegendInto(containerId){
  const host=document.getElementById(containerId); if(!host) return;
  host.innerHTML='';
  ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
    const el=document.createElement('span'); el.className='legend-item';
    el.innerHTML=`<span class="swatch" style="background:${PARTY_COLORS[p]}"></span>${p}`;
    host.appendChild(el);
  });
}

/* ===== Boundaries ===== */
async function loadECJBoundaries(){
  const gj = await fetch(ECJ_GEOJSON, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error('Boundaries HTTP '+r.status); return r.json(); });
  arcFeatures = gj.features || [];
  byParish = {}; constNameToNo={}; constNameToParish={};
  arcFeatures.forEach(f=>{
    const p=f.properties||{};
    const parish = p.PARISH_NAM || p.PARISH_NAME || '';
    const cname  = p.CONST_NAME || p.CONSTNAME || p.Name || '';
    const cno    = p.CONST_NO || p.CONSTNO || p.Number || '';
    const key=norm(cname);
    if (parish) (byParish[parish] ||= []);
    constNameToNo[key]=(cno||'').toString();
    constNameToParish[key]=parish||'';
  });
}

/* ===== Topline / score / charts / closest ===== */
function buildToplineBar(totals,seats){
  const el=document.getElementById('toplineBar'); el.innerHTML='';
  const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
  const deltas={}; ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{ const prev=lastSeats?.[p]||0; const cur=seats[p]||0; deltas[p]=cur-prev; });
  localStorage.setItem('lastSeats', JSON.stringify(seats)); lastSeats=seats;
  ['JLP','PNP','JPP','UIC','Other'].forEach(p=>{
    const votes=totals[p]||0, s=seats[p]||0; const pct=((votes/(totalVotes||1))*100).toFixed(1); const d=deltas[p]||0;
    const deltaHtml = d?`<span class="delta ${d>0?'up':'down'}">${d>0?'▲':'▼'} ${Math.abs(d)}</span>`:'';
    const card=document.createElement('div'); card.className='tcard';
    card.innerHTML = `<img class="tlogo" src="${PARTY_LOGOS[p]}" alt="${p} logo" referrerpolicy="no-referrer">
      <div class="tstats"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; <b>${votes.toLocaleString()}</b> votes &nbsp;|&nbsp; <b>${pct}%</b></div>`;
    el.appendChild(card);
  });
}
function buildScoreboard(totals,seats){
  const el=document.getElementById('scoreboard'); if(!el) return; el.innerHTML='';
  const totalVotes=Object.values(totals).reduce((a,b)=>a+b,0)||1;
  const prev = JSON.parse(localStorage.getItem('lastSeats')||'{}');
  [{key:'JLP', name:'Jamaica Labour Party', color:PARTY_COLORS.JLP},
   {key:'PNP', name:'People’s National Party', color:PARTY_COLORS.PNP},
   {key:'Other', name:'Others (JPP, UIC, etc.)', color:PARTY_COLORS.Other}].forEach(g=>{
    const votes=totals[g.key]||0, s=seats[g.key]||0, pct=((votes/(totalVotes||1))*100).toFixed(1);
    const delta=s-(prev?.[g.key]||0);
    const deltaHtml = delta?`<span class="delta ${delta>0?'up':'down'}">${delta>0?'▲':'▼'} ${Math.abs(delta)}</span>`:'';
    const div=document.createElement('div'); div.className='pcard';
    div.innerHTML = `<div class="phead"><strong style="color:${g.color}">${g.name}</strong><div class="pmain" style="color:${g.color}">${pct}%</div></div>
      <div class="bar"><span style="width:${pct}%; background:${g.color}"></span></div>
      <div style="margin-top:8px; color:var(--muted)"><b>${s}</b> seats ${deltaHtml} &nbsp;|&nbsp; Votes: ${votes.toLocaleString()}</div>`;
    el.appendChild(div);
  });
}
function buildCharts(totals,seats){
  const vc=document.getElementById('voteChart'), sc=document.getElementById('seatChart');
  try{ voteChart && voteChart.destroy(); }catch(_){}
  try{ seatChart && seatChart.destroy(); }catch(_){}
  const labels=Object.keys(totals); if(!labels.length) return;
  const colors=labels.map(p=>PARTY_COLORS[p]||PARTY_COLORS.Other);
  voteChart=new Chart(vc,{type:'pie',data:{labels,datasets:[{data:labels.map(k=>totals[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  seatChart=new Chart(sc,{type:'bar',data:{labels,datasets:[{label:'Seats',data:labels.map(k=>seats[k]||0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0}}}});
}
function buildClosestPanel(items){
  const list=document.getElementById('closestList'), note=document.getElementById('closestNote'); if(!list) return;
  list.innerHTML='';
  const top10 = items.filter(x=>!isNaN(x.marginPct)).sort((a,b)=>a.marginPct-b.marginPct).slice(0,10);
  top10.forEach(item=>{
    const color=PARTY_COLORS[partyKey(item.winnerParty)]||PARTY_COLORS.Other;
    const li=document.createElement('li');
    li.innerHTML = `<span><strong>${item.constituency}</strong> — <span style="color:${color}">${item.winnerFirst} ${item.winnerLast} (${partyKey(item.winnerParty)})</span></span><span><strong>${item.marginPct.toFixed(1)}%</strong></span>`;
    li.title = item.candidates.map(c=>`${c.name} (${partyKey(c.party)}): ${c.votes.toLocaleString()} • ${c.pct}%`).join(' | ');
    li.addEventListener('click', ()=> gotoInteractive(item.constituency));
    list.appendChild(li);
  });
  note.textContent='Margin = percentage-point gap between 1st and 2nd.';
}

/* ===== Map coloring & interactions ===== */
function paintMap(layer, detailsByConst){
  if (!layer) return;
  layer.eachLayer(Ly=>{
    const nm = Ly.feature?.properties?.CONST_NAME || '';
    const key = norm(nm);
    const info = detailsByConst[key];
    if (info){
      const fill = PARTY_COLORS[partyKey(info.party)] || PARTY_COLORS.Other;
      leaderColors[key]=fill;

      const disp = `${nm}${constNameToNo[key]?` (#${constNameToNo[key]})`:''}`;

      const strokeWeight = (focusedKey && focusedKey===key) ? 3 : 1;
      const strokeColor  = (focusedKey && focusedKey===key) ? '#111827' : '#94a3b8';
      Ly.setStyle({ fillColor: fill, fillOpacity:0.75, color:strokeColor, weight:strokeWeight });

      /* SHOW ALL CANDIDATES IN TOOLTIP */
      const rows = (info.all||[]).map(c=>{
        const party = partyKey(c.party);
        const col = PARTY_COLORS[party] || PARTY_COLORS.Other;
        return `<div><span style="color:${col}; font-weight:700">${c.name}</span> (${party}) — ${c.votes.toLocaleString()} • ${c.pct}%</div>`;
      }).join('');
      Ly.bindTooltip(`<div style="min-width:260px"><div style="font-weight:800;margin-bottom:4px">${disp}</div>${rows}</div>`, {sticky:true});
    }else{
      Ly.setStyle({ fillColor:'#e5e7eb', fillOpacity:0.6, color:'#94a3b8', weight:1 });
      Ly.bindTooltip(`<div><strong>${nm}</strong><br/><span style="color:#d1d5db">No result yet.</span></div>`, {sticky:true});
    }
  });
}
function updateFocusOutline(){
  if (!geoLayerInteractive) return;
  geoLayerInteractive.eachLayer(l=>{
    const nm = l.feature?.properties?.CONST_NAME || '';
    const key = norm(nm);
    const fill = leaderColors[key] || '#e5e7eb';
    const isFocused = focusedKey && focusedKey===key;
    l.setStyle({ fillColor: fill, fillOpacity:0.75, color: isFocused? '#111827':'#94a3b8', weight: isFocused? 3:1 });
    if (isFocused) try{ l.bringToFront(); }catch(_){}
  });
}
function wireInteractiveBehaviors(){
  const hoverTimers = new WeakMap();
  byParish = {};
  geoLayerInteractive.eachLayer(l=>{
    const parish = l.feature?.properties?.PARISH_NAM;
    (byParish[parish] ||= []).push(l);
  });
  geoLayerInteractive.eachLayer(layer=>{
    const nm = layer.feature?.properties?.CONST_NAME || '';
    const parish = layer.feature?.properties?.PARISH_NAM || '';
    const key = norm(nm);

    layer.on('click', ()=>{
      const grp = byParish[parish] || [layer];
      const group = L.featureGroup(grp);
      try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
      focusedKey = key; updateFocusOutline();
      showConstituencyDetails(key, nm);
    });
    layer.on('mouseover', e=>{
      const t = setTimeout(()=>{ e.target.openTooltip(); }, 800);
      hoverTimers.set(layer, t);
      e.target.setStyle({ weight: (focusedKey===key? 3:2), color:'#111827', fillOpacity:0.9 }); e.target.bringToFront();
    });
    layer.on('mouseout', e=>{
      clearTimeout(hoverTimers.get(layer));
      e.target.closeTooltip();
      const fill = leaderColors[key] || '#e5e7eb';
      const wt = (focusedKey===key)? 3 : 1;
      const col = (focusedKey===key)? '#111827' : '#94a3b8';
      e.target.setStyle({ fillColor: fill, fillOpacity:0.75, color: col, weight: wt });
    });
  });
}

/* ===== Details panel ===== */
function showConstituencyDetails(normKey, featureName){
  const cont=document.getElementById('imapContent');
  cont.dataset.currentKey = normKey;
  const block = document.querySelector(`.const[data-key="${normKey}"]`);
  if (!block){ cont.textContent='No data found.'; return; }
  const rows = JSON.parse(block.dataset.candidates || '[]');
  const updated = block.dataset.updated ? Number(block.dataset.updated) : null;
  const cNo = block.dataset.constno ? ` (#${block.dataset.constno})` : '';

  const ageMs = Date.now() - (updated||Date.now());
  let dotColor = 'var(--bad)';
  if (ageMs <= 5*60*1000) dotColor = 'var(--good)';
  else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

  const dispName = featureName + cNo;
  const boxStr = block.dataset.boxes || '';
  const boxPct = block.dataset.boxpct || '';

  let html = `<h3 style="margin:4px 0">${dispName}</h3>`;
  html += `
    <div class="updated">
      <span>Last updated:</span>
      <span><span class="pulse" style="color:${dotColor}"></span>
        <span style="font-variant-numeric:tabular-nums">${fmtHHMMSS(Date.now()-(updated||Date.now()))}</span> ago
      </span>
    </div>
    ${boxStr ? `<div class="boxline">Boxes counted: <strong>${boxStr}</strong>${boxPct?` (${boxPct}%)`:''}</div>` : ''}
  `;
  html += `<table style="width:100%; border-collapse:collapse; margin-top:6px"><thead><tr><th style="width:28px"></th><th>Candidate</th><th>Party</th><th style="text-align:right">Votes</th><th style="text-align:right">%</th></tr></thead><tbody>`;
  rows.forEach(r=>{
    const P = partyKey(r.party);
    const icon = PARTY_SYMBOLS[P] || PARTY_SYMBOLS.Other;
    const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}; font-weight:700"`;
    html += `<tr>
      <td><img src="${icon}" alt="${P}" class="party-icon" referrerpolicy="no-referrer"></td>
      <td ${nameStyle}>${r.name}</td>
      <td>${P}</td>
      <td style="text-align:right; font-weight:800">${Number(r.votes||0).toLocaleString()}</td>
      <td style="text-align:right">${r.pct||0}%</td>
    </tr>`;
  });
  html += `</tbody></table>`;
  cont.innerHTML = html;
}

/* ===== Render parish blocks + filters + SORT ===== */
function renderParishBlocks(detailsByConst, rawData){
  const host=document.getElementById('parishContainer'); host.innerHTML='';
  const parishSel = document.getElementById('parishFilter');
  const partySel  = document.getElementById('partyFilter');
  const cnoInp    = document.getElementById('cnoFilter');
  const sortField = document.getElementById('sortField').value;
  const sortDir   = document.getElementById('sortDir').value;

  const allKeys = Object.keys(detailsByConst);
  const parishOf = k => constNameToParish[k] || '';
  const cnoOf    = k => (constNameToNo[k] || '');
  const recOf    = k => Object.values(rawData).find(x=> norm(x?.Name)===k);
  const nameOf   = k => (recOf(k)?.Name || k);
  const leadPartyOf = k => detailsByConst[k]?.all?.[0]?.party || 'Other';

  const parishSet = new Set(allKeys.map(parishOf));
  let parishes = Array.from(parishSet).sort((a,b)=> a.localeCompare(b));
  if (sortField==='parish') parishes.sort((a,b)=> sortDir==='asc'? a.localeCompare(b):b.localeCompare(a));

  const curParish = parishSel.value;
  parishSel.innerHTML = `<option value="">All Parishes</option>` + parishes.map(p=>`<option ${curParish===p?'selected':''} value="${p}">${p}</option>`).join('');

  const filterParish = parishSel.value;
  const filterParty  = partySel.value;
  const filterCno    = cnoInp.value.trim();

  parishes.forEach(parish=>{
    if (filterParish && parish!==filterParish) return;
    let keys = allKeys.filter(k=> parishOf(k)===parish);

    keys.sort((ka,kb)=>{
      let A,B;
      switch (sortField){
        case 'cno':   A=Number(cnoOf(ka)||0); B=Number(cnoOf(kb)||0); break;
        case 'name':  A=nameOf(ka).toLowerCase(); B=nameOf(kb).toLowerCase(); break;
        case 'party': A=leadPartyOf(ka); B=leadPartyOf(kb); break;
        case 'parish':A=parishOf(ka); B=parishOf(kb); break;
        default: A=nameOf(ka).toLowerCase(); B=nameOf(kb).toLowerCase();
      }
      if (A<B) return sortDir==='asc'?-1:1;
      if (A>B) return sortDir==='asc'? 1:-1;
      return 0;
    });

    const wrap=document.createElement('div'); wrap.className='parish';
    wrap.innerHTML = `<h2>${parish||'—'}</h2><div class="const-grid"></div>`;
    const grid = wrap.querySelector('.const-grid');

    keys.forEach(key=>{
      const info = detailsByConst[key];
      const record = recOf(key);
      const origName = record?.Name || key;
      const cNo = constNameToNo[key] || '';

      if (filterParty && !info.all.some(c=> partyKey(c.party)===filterParty)) return;
      if (filterCno && !String(cNo).startsWith(filterCno)) return;

      const winnerParty = partyKey(info.all?.[0]?.party || 'Other');
      const winnerObj = info.all?.[0] || null;

      const bg = PARTY_COLORS[winnerParty] || PARTY_COLORS.Other;
      const textColor = contrastText(bg);
      const candidatesPayload = JSON.stringify(info.all || []);
      const updatedTs = lastConstUpdated[key] || '';

      // Boxes / declare rule (full or >=95%)
      let boxes = '', boxpct = '';
      let countedBoxes=0, totalBoxes=0, fullCounted=false, pctNum=0, canDeclare=false;
      if (record?.Data){
        const d = Array.isArray(record.Data)? record.Data[0] : record.Data;
        boxes  = d?.["Boxes Counted"] || '';
        boxpct = (d?.["Box Counted Percentage"]!=null) ? String(d["Box Counted Percentage"]) : '';
        const m = boxes ? String(boxes).match(/(\d+)\s*of\s*(\d+)/i) : null;
        if (m){ countedBoxes=+m[1]; totalBoxes=+m[2]; fullCounted = totalBoxes>0 && countedBoxes===totalBoxes; }
        pctNum = Number(boxpct)||0;
        canDeclare = fullCounted || (pctNum>=95);
      }

      const el=document.createElement('div'); el.className='const';
      el.dataset.key = key;
      el.dataset.constno = cNo;
      el.dataset.updated = updatedTs;
      el.dataset.candidates = candidatesPayload;
      el.dataset.boxes = boxes;
      el.dataset.boxpct = boxpct;

      el.dataset.search = [origName, cNo, parish, ...(info.all||[]).map(c=>`${c.name} ${partyKey(c.party)}`)].join(' ').toLowerCase();
      el.dataset.parish = parish;
      el.dataset.parties = (info.all||[]).map(c=>partyKey(c.party)).join('|');
      el.dataset.cno = cNo;

      el.style.borderColor = bg;

      const ageMs = Date.now() - (updatedTs||Date.now());
      let dotColor = 'var(--bad)';
      if (ageMs <= 5*60*1000) dotColor = 'var(--good)';
      else if (ageMs <= 20*60*1000) dotColor = 'var(--warn)';

      const niceName = `${origName} ${cNo?`(#${cNo})`:''}`;

      const winnerBadgeHTML = (canDeclare && winnerObj)
        ? `<div class="winner-badge" style="background:${bg}; color:${textColor}; border-color:${bg}">
             <span class="check">✓</span> ${winnerObj.name} (${winnerParty})
           </div>`
        : (winnerObj
           ? `<div class="winner-badge" style="background:#fff; color:#0b1220; border-color:var(--border)">
                Leading: <strong style="color:${PARTY_COLORS[winnerParty]||'#555'}">${winnerObj.name} (${winnerParty})</strong>
              </div>`
           : ``);

      const rowsHTML = (info.all||[]).map(c=>{
        const P=partyKey(c.party), icon=PARTY_SYMBOLS[P]||PARTY_SYMBOLS.Other;
        const nameStyle = `style="color:${PARTY_COLORS[P]||PARTY_COLORS.Other}"`;
        return `<div class="row">
          <img class="party-icon" src="${icon}" alt="${P}" referrerpolicy="no-referrer">
          <div class="nm" ${nameStyle}>${c.name}</div>
          <div class="party">${P}</div>
          <div class="votes">${Number(c.votes||0).toLocaleString()}</div>
          <div class="pct">${c.pct||0}%</div>
        </div>`;
      }).join('');

      el.innerHTML = `
        <div class="const-head">
          <div class="const-name">${niceName}</div>
          <span class="updated">
            <span>Last updated:</span>
            <span><span class="pulse" style="color:${dotColor}"></span>
              <span class="timer" data-ts="${updatedTs||''}" style="font-variant-numeric:tabular-nums">
                ${fmtHHMMSS(Date.now()-(updatedTs||Date.now()))}
              </span> ago
            </span>
          </span>
        </div>
        <div class="const-body">
          ${winnerBadgeHTML}
          ${boxes? `<div class="boxline">Boxes counted: <strong>${boxes}</strong>${boxpct?` (${boxpct}%)`:''}</div>` : ''}
          <div class="rows">${rowsHTML}</div>
        </div>
      `;
      el.addEventListener('click', ()=> gotoInteractiveKey(key));
      grid.appendChild(el);
    });

    if (grid.children.length) document.getElementById('parishContainer').appendChild(wrap);
  });

  // Simple text search across blocks
  const sb = document.getElementById('searchBar');
  function applyTextFilter(){
    const q = sb.value.trim().toLowerCase();
    document.querySelectorAll('.const').forEach(card=>{
      const hit = !q || card.dataset.search.includes(q);
      card.style.display = hit ? '' : 'none';
    });
    document.querySelectorAll('.parish').forEach(p=>{
      const any = p.querySelector('.const-grid').children.length &&
                  Array.from(p.querySelectorAll('.const')).some(x=> x.style.display!=='none');
      p.style.display = any ? '' : 'none';
    });
  }
  sb.oninput = applyTextFilter;
}

/* ===== Periodic timers + sidebar + ticker ===== */
function tickTimersAndRecent(){
  document.querySelectorAll('.const .timer').forEach(t=>{
    const ts = Number(t.dataset.ts||0);
    if (!ts) { t.textContent = '00:00:00'; return; }
    const age = Date.now()-ts;
    t.textContent = fmtHHMMSS(age);
    const dot = t.parentElement?.querySelector('.pulse');
    if (dot){
      let col='var(--bad)';
      if (age <= 5*60*1000) col='var(--good)';
      else if (age <= 20*60*1000) col='var(--warn)';
      dot.style.color = col;
    }
  });

  const recents = []; const ticker  = [];
  Object.keys(lastConstUpdated).forEach(k=>{
    const ts = lastConstUpdated[k];
    const age = Date.now()-ts;
    const name = Object.values(window.__rawData||{}).find(x=> norm(x?.Name)===k)?.Name || k;
    const num = constNameToNo[k] || '';
    if (ts && age <= SIDEBAR_MAX_AGE) recents.push({k, name, num, ts, age});
    if (ts && age <= TICKER_MAX_AGE)  ticker.push({k, name, num, ts, age});
  });
  recents.sort((a,b)=> b.ts - a.ts);
  ticker.sort((a,b)=> b.ts - a.ts);

  const side = document.getElementById('sidebarList');
  side.innerHTML='';
  recents.forEach(r=>{
    const el=document.createElement('div');
    el.className='sideitem';
    el.dataset.key = r.k;
    if (r.age <= 5*60*1000) el.classList.add('age-good');
    else if (r.age <= 20*60*1000) el.classList.add('age-warn');
    else el.classList.add('age-bad');
    el.innerHTML=`<span>#${r.num||'—'}</span><small>${fmtHHMMSS(r.age)}</small>`;
    el.addEventListener('click', ()=> gotoInteractiveKey(r.k));
    side.appendChild(el);
  });

  const tick = document.getElementById('tickerText');
  if (ticker.length){
    const parts = ticker.map(r=> `${r.name}${r.num?` (#${r.num})`:''} — ${fmtHHMMSS(Date.now()-r.ts)} ago`);
    tick.textContent = '   •   ' + parts.join('   •   ') + '   •   ';
  }else{
    tick.textContent = '— No constituency updated in the last 15 minutes —';
  }

  // Keep the timer on the interactive details panel fresh
  const imTimer = document.querySelector('#imapContent .updated span[style*="font-variant-numeric"]');
  const imDot   = document.querySelector('#imapContent .updated .pulse');
  const curKey = document.getElementById('imapContent')?.dataset?.currentKey;
  if (imTimer && curKey && lastConstUpdated[curKey]){
    const age = Date.now()-lastConstUpdated[curKey];
    imTimer.textContent = fmtHHMMSS(age);
    if (imDot){
      let col='var(--bad)'; if (age<=5*60*1000) col='var(--good)'; else if (age<=20*60*1000) col='var(--warn)';
      imDot.style.color = col;
    }
  }
}

/* ===== Data load ===== */
async function loadData(){
  try{
    if (!arcFeatures.length){ try{ await loadECJBoundaries(); }catch(_){ toast('Could not load boundaries.'); } }
    initNationalMap(); initInteractiveMap();
    buildLegendInto('mapLegend'); buildLegendInto('imapLegend');

    // Fetch primary election data (proxy-aware)
    const data = await fetch(bust(DATA_URL), {cache:'no-store'})
      .then(r=>{ if(!r.ok) throw new Error('Data HTTP '+r.status); return r.json(); });

    window.__rawData = data;

    if (!geoLayerNational){
      geoLayerNational = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapNational);
    }
    if (!geoLayerInteractive){
      geoLayerInteractive = L.geoJSON({type:'FeatureCollection', features: arcFeatures},{ style:()=>({ color:'#94a3b8', weight:1, fillColor:'#e5e7eb', fillOpacity:0.6 })}).addTo(mapInteractive);
    }

    const partyTotals={}, partySeats={}, detailsByConst={}, closestArr=[];
    Object.values(data).forEach(c=>{
      const cname=c?.Name||''; const cData=Array.isArray(c?.Data)? c.Data[0] : c?.Data;
      const cand = Array.isArray(cData?.Candidates)? cData.Candidates : [];
      if(!cname || !cand.length) return;
      const key = norm(cname);
      const safePct  = (x)=> Number(x)||0;
      const safeVote = (x)=> Number(x)||0;
      const winner = cand.reduce((m,x)=> safeVote(x.Votes)>safeVote(m.Votes)? x : m, cand[0]);
      const sorted = cand.slice().sort((a,b)=> safePct(b.Percentage)-safePct(a.Percentage)).map(k=>({
        name:`${(k["First Name"]||'').trim()} ${(k["Last Name"]||'').trim()}`.trim(),
        party:partyKey(k.Party),
        votes:safeVote(k.Votes),
        pct:safePct(k.Percentage)
      }));

      const byP = Object.fromEntries(sorted.map(x=>[x.party,x]));
      const top2 = (byP.JLP || sorted[0]) ? [byP.JLP || sorted[0], byP.PNP || sorted.find(x=>x!== (byP.JLP||sorted[0])) || sorted[1] || (byP.JLP||sorted[0])] : sorted.slice(0,2);

      const sig = makeHash(cand);
      if (lastConstHashes[key] !== sig){
        lastConstHashes[key] = sig;
        lastConstUpdated[key] = Date.now();
        localStorage.setItem('constituencyHashes', JSON.stringify(lastConstHashes));
        localStorage.setItem('constituencyUpdated', JSON.stringify(lastConstUpdated));
      }

      detailsByConst[key] = { party:partyKey(winner?.Party), all: sorted, top2 };
      cand.forEach(k=>{ const p=partyKey(k.Party); partyTotals[p]=(partyTotals[p]||0)+safeVote(k.Votes); });
      partySeats[partyKey(winner?.Party)] = (partySeats[partyKey(winner?.Party)]||0)+1;

      const topPct = sorted[0]?.pct||0, runnerPct=sorted[1]?.pct||0;
      closestArr.push({
        constituency:cname,
        winnerFirst: sorted[0]?.name.split(' ')[0]||'',
        winnerLast:  (sorted[0]?.name.split(' ').slice(1).join(' '))||'',
        winnerParty: sorted[0]?.party||'Other',
        marginPct: Math.max(0,(topPct-runnerPct)),
        candidates: sorted
      });
    });

    const {totals: groupedTotals, seats: groupedSeats} = groupSmallParties(partyTotals, partySeats, 0.02, Object.keys(PARTY_COLORS));

    buildToplineBar(groupedTotals, groupedSeats);
    buildScoreboard(groupedTotals, groupedSeats);
    buildCharts(groupedTotals, groupedSeats);
    buildClosestPanel(closestArr);
    renderParishBlocks(detailsByConst, data);
    paintMap(geoLayerNational, detailsByConst);
    paintMap(geoLayerInteractive, detailsByConst);
    wireInteractiveBehaviors();
    updateFocusOutline();

    document.getElementById('lastUpdated').textContent = "Live • " + new Date().toLocaleTimeString();

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(tickTimersAndRecent, 1000);
    tickTimersAndRecent();
  }catch(e){ console.error(e); toast('Partial update — check console.'); }
}
function groupSmallParties(totals,seats,threshold=0.02, keep=[]){
  const total=Object.values(totals).reduce((a,b)=>a+b,0)||1;
  const T={}, S={};
  Object.keys(totals).forEach(p=>{
    const share=(totals[p]/total);
    const bucket = (!keep.includes(p) && share < threshold) ? 'Other' : p;
    T[bucket]=(T[bucket]||0)+totals[p];
    S[bucket]=(S[bucket]||0)+(seats[p]||0);
  });
  return {totals:T, seats:S};
}

/* ===== Parity check (Main vs Backup) — using BOXES COUNTED ===== */
async function fetchJsonSafe(url){
  try{
    const r = await fetch(bust(url), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){ return {__error: e.message || 'fetch-error'}; }
}
function buildCountMap(dataset){
  // Map of constituency -> counted boxes (number from "X of Y")
  const out = {};
  if (!dataset || dataset.__error) return out;
  Object.values(dataset).forEach(c=>{
    const cname = c?.Name || '';
    if (!cname) return;
    const key = norm(cname);
    const d = Array.isArray(c?.Data) ? c.Data[0] : (c?.Data||{});
    let counted = 0;
    if (d && typeof d["Boxes Counted"] === "string") {
      const m = d["Boxes Counted"].match(/(\d+)\s*of\s*(\d+)/i);
      if (m) counted = Number(m[1]);
    }
    out[key] = counted;
  });
  return out;
}
function summarizeParity(mainMap, backupMap){
  const keys = new Set([...Object.keys(mainMap), ...Object.keys(backupMap)]);
  const diffs = [];
  let mainBehind=0, backupBehind=0;
  keys.forEach(k=>{
    const m = Number(mainMap[k]||0);
    const b = Number(backupMap[k]||0);
    if (m !== b){
      diffs.push({key:k, main:m, backup:b});
      if (m < b) mainBehind++;
      if (b < m) backupBehind++;
    }
  });
  return { diffs, mainBehind, backupBehind };
}
function setPillState(which, state, tooltip, subtext){
  const pill = document.getElementById(which==='main' ? 'pillMain' : 'pillBackup');
  const dot  = pill?.querySelector('.dot');
  const txt  = document.getElementById(which==='main' ? 'mainLag' : 'backupLag');
  if (!pill || !dot || !txt) return;
  dot.classList.remove('ok','warn','bad');
  dot.classList.add(state);
  pill.title = tooltip || '';
  txt.textContent = subtext || (state==='ok' ? 'OK' : state==='warn' ? 'Check' : 'Offline');
}
function formatDiffTooltip(diffs, maxItems=6){
  if (!diffs.length) return 'OK';
  const head = `${diffs.length} constituency${diffs.length>1?'ies':''} differ (Boxes Counted)`;
  const lines = diffs.slice(0,maxItems).map(d=>{
    const nm = Object.values(window.__rawData||{}).find(x=> norm(x?.Name)===d.key)?.Name || d.key;
    return `• ${nm}: Main ${d.main.toLocaleString()} vs Backup ${d.backup.toLocaleString()}`;
  });
  return [head, ...lines].join('\n');
}
async function runParityCheck(){
  const [mainData, backupData] = await Promise.all([
    fetchJsonSafe(MAIN_DATA_URL),
    fetchJsonSafe(BACKUP_DATA_URL)
  ]);

  const mainErr = !!mainData.__error;
  const backErr = !!backupData.__error;

  if (mainErr && backErr){
    setPillState('main',   'bad',  'Main unreachable',   'Offline');
    setPillState('backup', 'bad',  'Backup unreachable', 'Offline');
    return;
  }
  if (mainErr){
    setPillState('main',   'bad',  'Main unreachable',   'Offline');
    setPillState('backup', 'warn', 'Main unreachable (comparing unavailable)', 'OK');
    return;
  }
  if (backErr){
    setPillState('backup', 'bad',  'Backup unreachable', 'Offline');
    setPillState('main',   'warn', 'Backup unreachable (comparing unavailable)', 'OK');
    return;
  }

  const mainMap   = buildCountMap(mainData);
  const backupMap = buildCountMap(backupData);
  const { diffs, mainBehind, backupBehind } = summarizeParity(mainMap, backupMap);

  if (!diffs.length){
    setPillState('main',   'ok',   'Main matches Backup across all constituencies (Boxes Counted)',   'OK');
    setPillState('backup', 'ok',   'Backup matches Main across all constituencies (Boxes Counted)',   'OK');
    return;
  }

  const tip = formatDiffTooltip(diffs);
  if (mainBehind > backupBehind){
    setPillState('main',   'warn', tip + '\n(Main appears behind)',   'Behind');
    setPillState('backup', 'warn', tip + '\n(Main appears behind)',   'Ahead');
  }else if (backupBehind > mainBehind){
    setPillState('backup', 'warn', tip + '\n(Backup appears behind)', 'Behind');
    setPillState('main',   'warn', tip + '\n(Backup appears behind)', 'Ahead');
  }else{
    setPillState('main',   'warn', tip + '\n(Mixed differences)',   'Check');
    setPillState('backup', 'warn', tip + '\n(Mixed differences)',   'Check');
  }
}

/* ===== Deep link + handshake ===== */
function gotoInteractive(name){
  const k = norm(name);
  const resolved = ALIASES[k] || k;
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
  document.getElementById('tab-interactive').classList.remove('hidden');

  if (!geoLayerInteractive){ pendingFocusName = resolved; return; }
  focusConstituencyByName(resolved, true);
  setTimeout(()=> mapInteractive.invalidateSize(), 80);
  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function gotoInteractiveKey(key){
  document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelector('.tab[data-tab="interactive"]').classList.add('active');
  document.getElementById('tab-interactive').classList.remove('hidden');

  if (!geoLayerInteractive){ pendingFocusName = key; return; }
  focusConstituencyByName(key, true);
  setTimeout(()=> mapInteractive.invalidateSize(), 80);
  document.getElementById('imapDetails').scrollIntoView({behavior:'smooth', block:'start'});
}
function focusConstituencyByNumber(no){
  if (!geoLayerInteractive) return false;
  let found=null, parish=null, display=null, key=null;
  geoLayerInteractive.eachLayer(L=>{
    const p = L.feature?.properties||{};
    const n = String(p.CONST_NO || p.CONSTNO || p.Number || '');
    if (n === String(no)){
      found=L; parish=p.PARISH_NAM; display=p.CONST_NAME; key=norm(p.CONST_NAME||'');
    }
  });
  if (!found) return false;
  const grp=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) grp.push(l); });
  const group = L.featureGroup(grp.length? grp:[found]);
  try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
  focusedKey = key; updateFocusOutline();
  setTimeout(()=> found.openTooltip(), 250);
  showConstituencyDetails(key, display||`#${no}`);
  return true;
}
function focusConstituencyByName(nameOrKey, isKey=false){
  if (!geoLayerInteractive) return;
  const rawK = isKey ? nameOrKey : norm(nameOrKey);
  const keyWanted = ALIASES[rawK] || rawK;

  let target=null, parish=null, display=null;
  geoLayerInteractive.eachLayer(L=>{
    const nm = L.feature?.properties?.CONST_NAME || '';
    const k = norm(nm);
    if (k===keyWanted){ target=L; parish = L.feature?.properties?.PARISH_NAM; display=nm; }
  });

  if (target){
    const grp = (function(){ const arr=[]; geoLayerInteractive.eachLayer(l=>{ if (l.feature?.properties?.PARISH_NAM===parish) arr.push(l); }); return arr; })();
    const group = L.featureGroup(grp.length? grp:[target]);
    try{ mapInteractive.fitBounds(group.getBounds(), {padding:[10,10]}); }catch(e){}
    focusedKey = keyWanted; updateFocusOutline();
    setTimeout(()=> target.openTooltip(), 250);
    showConstituencyDetails(keyWanted, display||nameOrKey);
  } else {
    const number = constNameToNo[keyWanted] || constNameToNo[ALIASES[keyWanted]||''];
    if (number && focusConstituencyByNumber(number)) return;
    setTimeout(()=> focusConstituencyByName(nameOrKey, isKey), 150);
  }
}

/* ===== Auto ===== */
function setupAutoRefresh(){
  if (refreshTimer) clearInterval(refreshTimer);
  const ms = Number(localStorage.getItem('refreshIntervalMs')||sel.value||AUTO_DEFAULT);
  refreshTimer = setInterval(loadData, ms);
}

/* ===== Start ===== */
(async function start(){
  try{ await loadECJBoundaries(); }catch(_){}
  initNationalMap(); initInteractiveMap();
  buildLegendInto('mapLegend'); buildLegendInto('imapLegend');
  await loadData();
  setupAutoRefresh();

  // Parity check now and every 5 minutes (Boxes Counted)
  runParityCheck();
  setInterval(runParityCheck, PARITY_INTERVAL_MS);
})();
</script>
</body>
</html>
